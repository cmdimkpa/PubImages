<div style="font-family: 'Lucida Grande', 'Segoe UI', 'Apple SD Gothic Neo', 'Malgun Gothic', 'Lucida Sans Unicode', Helvetica, Arial, sans-serif; font-size: 0.9em; overflow-x: hidden; overflow-y: auto; margin: 0px !important; padding: 5px 20px 26px !important; background-color: rgb(255, 255, 255);font-family: 'Hiragino Sans GB', 'Microsoft YaHei', STHeiti, SimSun, 'Lucida Grande', 'Lucida Sans Unicode', 'Lucida Sans', 'Segoe UI', AppleSDGothicNeo-Medium, 'Malgun Gothic', Verdana, Tahoma, sans-serif; padding: 20px;padding: 20px; color: rgb(34, 34, 34); font-size: 15px; font-family: 'Roboto Condensed', Tauri, 'Hiragino Sans GB', 'Microsoft YaHei', STHeiti, SimSun, 'Lucida Grande', 'Lucida Sans Unicode', 'Lucida Sans', 'Segoe UI', AppleSDGothicNeo-Medium, 'Malgun Gothic', Verdana, Tahoma, sans-serif; line-height: 1.6; -webkit-font-smoothing: antialiased; background: rgb(255, 255, 255);"><h2 id="mac-model-2:-lte-mac-model-simulation-and-scheduler-comparison-project" style="clear: both;font-size: 1.8em; font-weight: bold; margin: 1.275em 0px 0.85em;margin-top: 0px;border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(230, 230, 230);"><a name="mac-model-2:-lte-mac-model-simulation-and-scheduler-comparison-project" href="#mac-model-2:-lte-mac-model-simulation-and-scheduler-comparison-project" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);"></a>MAC Model 2: LTE MAC Model Simulation and Scheduler Comparison Project</h2><p style="margin-top: 0px;margin: 1em 0px; word-wrap: break-word;">Authors: R. Ochi, C. Dimkpa<br style="clear: both;">Last Updated: August 9, 2020</p><p style="undefined; margin: 0px !important;margin: 1em 0px; word-wrap: break-word;"></p><ul>
<li style="display: list-item; line-height: 1.4em;"><ul>
<li style="display: list-item; line-height: 1.4em;"><span class="title">
<a href="#mac-model-2:-lte-mac-model-simulation-and-scheduler-comparison-project" title="MAC Model 2: LTE MAC Model Simulation and Scheduler Comparison Project" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);">MAC Model 2: LTE MAC Model Simulation and Scheduler Comparison Project</a>
</span>
<!--span class="number">
0
</span-->
<ul>
<li style="display: list-item; line-height: 1.4em;"><span class="title">
<a href="#abstract" title="Abstract" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);">Abstract</a>
</span>
<!--span class="number">
1
</span-->
</li>
<li style="display: list-item; line-height: 1.4em;"><span class="title">
<a href="#literature-review" title="Literature Review" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);">Literature Review</a>
</span>
<!--span class="number">
2
</span-->
</li>
<li style="display: list-item; line-height: 1.4em;"><span class="title">
<a href="#network-models" title="Network Models" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);">Network Models</a>
</span>
<!--span class="number">
3
</span-->
<ul>
<li style="display: list-item; line-height: 1.4em;"><span class="title">
<a href="#mac-layer-model" title="MAC Layer Model" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);">MAC Layer Model</a>
</span>
<!--span class="number">
4
</span-->
</li>
<li style="display: list-item; line-height: 1.4em;"><span class="title">
<a href="#lte-network-(server)-model" title="LTE Network (Server) Model" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);">LTE Network (Server) Model</a>
</span>
<!--span class="number">
5
</span-->
</li>
<li style="display: list-item; line-height: 1.4em;"><span class="title">
<a href="#network-services-(client)-model" title="Network Services (Client) Model" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);">Network Services (Client) Model</a>
</span>
<!--span class="number">
6
</span-->
</li>
</ul>
</li>
<li style="display: list-item; line-height: 1.4em;"><span class="title">
<a href="#online-interfaces" title="Online Interfaces" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);">Online Interfaces</a>
</span>
<!--span class="number">
7
</span-->
<ul>
<li style="display: list-item; line-height: 1.4em;"><span class="title">
<a href="#netlog---visualizing-the-simulated-lte-network" title="Netlog - visualizing the simulated LTE Network" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);">Netlog - visualizing the simulated LTE Network</a>
</span>
<!--span class="number">
8
</span-->
</li>
<li style="display: list-item; line-height: 1.4em;"><span class="title">
<a href="#scheduler-performance-comparison-tool" title="Scheduler Performance Comparison Tool" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);">Scheduler Performance Comparison Tool</a>
</span>
<!--span class="number">
9
</span-->
</li>
</ul>
</li>
<li style="display: list-item; line-height: 1.4em;"><span class="title">
<a href="#experimental-results-&amp;-discussion" title="Experimental Results &amp; Discussion" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);">Experimental Results &amp; Discussion</a>
</span>
<!--span class="number">
10
</span-->
</li>
<li style="display: list-item; line-height: 1.4em;"><span class="title">
<a href="#appendix" title="Appendix" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);">Appendix</a>
</span>
<!--span class="number">
11
</span-->
<ul>
<li style="display: list-item; line-height: 1.4em;"><span class="title">
<a href="#lte-sub-network-code-(python)" title="LTE Sub Network Code (Python)" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);">LTE Sub Network Code (Python)</a>
</span>
<!--span class="number">
12
</span-->
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>

</ul>
<p style="margin: 1em 0px; word-wrap: break-word;"></p><h3 id="abstract" style="clear: both;font-size: 1.6em; font-weight: bold; margin: 1.125em 0px 0.75em;"><a name="abstract" href="#abstract" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);"></a>Abstract</h3><h3 id="literature-review" style="clear: both;font-size: 1.6em; font-weight: bold; margin: 1.125em 0px 0.75em;"><a name="literature-review" href="#literature-review" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);"></a>Literature Review</h3><h3 id="network-models" style="clear: both;font-size: 1.6em; font-weight: bold; margin: 1.125em 0px 0.75em;"><a name="network-models" href="#network-models" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);"></a>Network Models</h3><h4 id="mac-layer-model" style="clear: both;font-size: 1.4em; font-weight: bold; margin: 0.99em 0px 0.66em;"><a name="mac-layer-model" href="#mac-layer-model" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);"></a>MAC Layer Model</h4><pre style="border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; word-wrap: break-word; border: 1px solid rgb(204, 204, 204); overflow: auto; padding: 0.5em;"><code data-origin="<pre><code>Project: MAC Layer Model Development

based on the paper:

S. Louvros, A. C. Iossifides, K. Aggelis, A. Baltagiannis and G. Economou, &quot;A Semi-Analytical Macroscopic MAC Layer Model for LTE Uplink,&quot; 
2012 5th International Conference on New Technologies, Mobility and Security (NTMS), Istanbul, 2012, pp. 1-5.

1. Inputs/Constraints:

    - MAC packet size (MAC PS)
    - Number of retransmissions (N RET)
    - Bit Error Rate (BER)
    - Allocated resources with respect to [cell load] (LOAD)
    - Delay budget requirements posed by QCI (DELAY)


2. Outputs:

    - Scheduling criteria: 

        - QoS service profile
        - CQI reports
        - UE uplink buffer sizes



3. Network Configuration:


                                          |&amp;lt;------------------------------------------------------- eNodeB Radio Interface (RI) ------------------------------^^^^----------&amp;gt;|     
                                          |                                                                           
                                          |           |&amp;lt;----------------------------------------- MAC Layer ------------------------------------&amp;gt;| 
             Air Interface (AI)           |___________|                                                               |
                                          |           |MAC Packets =                                     |            |
                                          |           |Roundup(M_I_var bits/(M_mac_payload bits +        |            |
                                          |           |M_over_header bits))                              |____________|
UE 1 -----------------------------------&amp;gt; |           |-------------------------------------------------&amp;gt;|            |
      (TCP/UDP IP Packet, M_I_var bits)   |           |                                                  |    MAC     |
                                          |           |MAC Packets =                                     |  Simulator |QoS profile  ___________
                                          | Physical  |Roundup(M_I_var bits/(M_mac_payload bits +        |  ________  |----------&amp;gt;|    MAC      |
                                          |  Uplink   |M_over_header bits))                              | | MAC PS | |CQI Reports                IP transmission data rate
UE 2 -----------------------------------&amp;gt; |  Control  |-------------------------------------------------&amp;gt;|  ________  |----------&amp;gt;|   Scheduler |---------------------------&amp;gt;
      (TCP/UDP IP Packet, M_I_var bits)   |  Channel  |                                                  | | N RET  | |UL Buf.Size
                                          |  (PUCCH)  |MAC Packets =                                     |  ________  |----------&amp;gt;| ___________ |
                                          |           |Roundup(M_I_var bits/(M_mac_payload bits +        | |  BER   | |          
                                          |           |M_over_header bits))                              |  ________  |
UE 3 -----------------------------------&amp;gt; |           |-------------------------------------------------&amp;gt;| |  LOAD  | |
      (TCP/UDP IP Packet, M_I_var bits)   |___________|                                                  |  ________  | 
                                          |           |                                                  | |  DELAY | |
                                          |           |                                                  |____________|
                                          |                                                              |            |
                                                                                                         |

4. Project Build Milestones

(a) Air Interface components - UE registration, IP packet transmission
(b) Physical Uplink Control Channel - MAC Packets Modulation from transmitted IP packet
(c) MAC Simulator - MAC PS, N RET, BER, LOAD, DELAY (using equations in paper)
(d) Scheduler Inputs - QoS service profile, CQI reports, UE Uplink Buffer Sizes
</code></pre>" style="border: 0px; display: block;font-family: Consolas, Inconsolata, Courier, monospace; font-weight: bold; white-space: pre; margin: 0px;border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; word-wrap: break-word; border: 1px solid rgb(204, 204, 204); padding: 0px 5px; margin: 0px 2px;font-size: 1em; letter-spacing: -1px; font-weight: bold;">Project: MAC Layer Model Development

based on the paper:

S. Louvros, A. C. Iossifides, K. Aggelis, A. Baltagiannis and G. Economou, "A Semi-Analytical Macroscopic MAC Layer Model for LTE Uplink," 
2012 5th International Conference on New Technologies, Mobility and Security (NTMS), Istanbul, 2012, pp. 1-5.

1. Inputs/Constraints:

    - MAC packet size (MAC PS)
    - Number of retransmissions (N RET)
    - Bit Error Rate (BER)
    - Allocated resources with respect to [cell load] (LOAD)
    - Delay budget requirements posed by QCI (DELAY)


2. Outputs:

    - Scheduling criteria: 

        - QoS service profile
        - CQI reports
        - UE uplink buffer sizes



3. Network Configuration:


                                          |&lt;------------------------------------------------------- eNodeB Radio Interface (RI) ------------------------------^^^^----------&gt;|     
                                          |                                                                           
                                          |           |&lt;----------------------------------------- MAC Layer ------------------------------------&gt;| 
             Air Interface (AI)           |___________|                                                               |
                                          |           |MAC Packets =                                     |            |
                                          |           |Roundup(M_I_var bits/(M_mac_payload bits +        |            |
                                          |           |M_over_header bits))                              |____________|
UE 1 -----------------------------------&gt; |           |-------------------------------------------------&gt;|            |
      (TCP/UDP IP Packet, M_I_var bits)   |           |                                                  |    MAC     |
                                          |           |MAC Packets =                                     |  Simulator |QoS profile  ___________
                                          | Physical  |Roundup(M_I_var bits/(M_mac_payload bits +        |  ________  |----------&gt;|    MAC      |
                                          |  Uplink   |M_over_header bits))                              | | MAC PS | |CQI Reports                IP transmission data rate
UE 2 -----------------------------------&gt; |  Control  |-------------------------------------------------&gt;|  ________  |----------&gt;|   Scheduler |---------------------------&gt;
      (TCP/UDP IP Packet, M_I_var bits)   |  Channel  |                                                  | | N RET  | |UL Buf.Size
                                          |  (PUCCH)  |MAC Packets =                                     |  ________  |----------&gt;| ___________ |
                                          |           |Roundup(M_I_var bits/(M_mac_payload bits +        | |  BER   | |          
                                          |           |M_over_header bits))                              |  ________  |
UE 3 -----------------------------------&gt; |           |-------------------------------------------------&gt;| |  LOAD  | |
      (TCP/UDP IP Packet, M_I_var bits)   |___________|                                                  |  ________  | 
                                          |           |                                                  | |  DELAY | |
                                          |           |                                                  |____________|
                                          |                                                              |            |
                                                                                                         |

4. Project Build Milestones

(a) Air Interface components - UE registration, IP packet transmission
(b) Physical Uplink Control Channel - MAC Packets Modulation from transmitted IP packet
(c) MAC Simulator - MAC PS, N RET, BER, LOAD, DELAY (using equations in paper)
(d) Scheduler Inputs - QoS service profile, CQI reports, UE Uplink Buffer Sizes
</code></pre><h4 id="lte-network-(server)-model" style="clear: both;font-size: 1.4em; font-weight: bold; margin: 0.99em 0px 0.66em;"><a name="lte-network-(server)-model" href="#lte-network-(server)-model" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);"></a>LTE Network (Server) Model</h4><p style="margin-top: 0px;margin: 1em 0px; word-wrap: break-word;"><img src="https://
cmdimkpa.github.io/MACModel2/GUI/assets/images/
lte-network-server.png" alt="LTE Network Console" style="max-width: 100%;"></p><h4 id="network-services-(client)-model" style="clear: both;font-size: 1.4em; font-weight: bold; margin: 0.99em 0px 0.66em;"><a name="network-services-(client)-model" href="#network-services-(client)-model" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);"></a>Network Services (Client) Model</h4><p style="margin-top: 0px;margin: 1em 0px; word-wrap: break-word;"><img src="https://
cmdimkpa.github.io/MACModel2/GUI/assets/images/
lte-network-services.png" alt="LTE Network Services Console" style="max-width: 100%;"></p><h3 id="online-interfaces" style="clear: both;font-size: 1.6em; font-weight: bold; margin: 1.125em 0px 0.75em;"><a name="online-interfaces" href="#online-interfaces" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);"></a>Online Interfaces</h3><h4 id="netlog---visualizing-the-simulated-lte-network" style="clear: both;font-size: 1.4em; font-weight: bold; margin: 0.99em 0px 0.66em;"><a name="netlog---visualizing-the-simulated-lte-network" href="#netlog---visualizing-the-simulated-lte-network" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);"></a>Netlog - visualizing the simulated LTE Network</h4><iframe src="https://sub-network-lte.herokuapp.com/SubNetworkLTE/NetLog" height="600" width="800" title="Network Log" style="border: 0px;"></iframe><h4 id="scheduler-performance-comparison-tool" style="clear: both;font-size: 1.4em; font-weight: bold; margin: 0.99em 0px 0.66em;"><a name="scheduler-performance-comparison-tool" href="#scheduler-performance-comparison-tool" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);"></a>Scheduler Performance Comparison Tool</h4><iframe src="https://cmdimkpa.github.io/MACModel2/GUI/schedulers-comparison.html" height="600" width="800" title="Scheduler Comparison" style="border: 0px;"></iframe><h3 id="experimental-results-&amp;-discussion" style="clear: both;font-size: 1.6em; font-weight: bold; margin: 1.125em 0px 0.75em;"><a name="experimental-results-&amp;-discussion" href="#experimental-results-&amp;-discussion" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);"></a>Experimental Results &amp; Discussion</h3><h3 id="appendix" style="clear: both;font-size: 1.6em; font-weight: bold; margin: 1.125em 0px 0.75em;"><a name="appendix" href="#appendix" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);"></a>Appendix</h3><h4 id="lte-sub-network-code-(python)" style="clear: both;font-size: 1.4em; font-weight: bold; margin: 0.99em 0px 0.66em;"><a name="lte-sub-network-code-(python)" href="#lte-sub-network-code-(python)" style="text-decoration: none; vertical-align: baseline;color: rgb(50, 105, 160);"></a>LTE Sub Network Code (Python)</h4><pre style="border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; word-wrap: break-word; border: 1px solid rgb(204, 204, 204); overflow: auto; padding: 0.5em;display: block; overflow-x: auto; padding: 0.5em; color: rgb(101, 123, 131); background: rgb(253, 246, 227);"><code class="python" data-origin="<pre><code class=&quot;python&quot;>#============== Python3 Flask Model of LTE Sub Network ==============

#   Version: 1.00
#   Author: Monty Dimkpa

#====================================================================


#-------------- Importing required Python libraries --------------

from flask import Flask, request, render_template, Response
from flask_cors import CORS
import sys
import os
import json
from random import random
import datetime
from hashlib import md5
from math import log10

app = Flask(__name__)
cors = CORS(app, resources={r&quot;/*&quot;: {&quot;origins&quot;: &quot;*&quot;}})

global server_host, server_port, scheduler_events, empty_retry_limit, MAC_packet_size, transmission_bit_limit_per_tti,\
       BER_baseline, retransmission_limit, packet_duplication, effective_delay_budget, min_IP_packet_size, max_IP_packet_size,\
       Transmission, NETWORK_DATA

#-------------- Network Initialization Parameters --------------

server_host = &quot;localhost&quot;
server_port = 5000
scheduler_events = 0
NETWORK_DATA = {}

#-------------- LTE Network Constants ------

# Transmission Bandwidth = 20MHz
# Number of RBs = 100 blocks
# RB Frequency = 180KHz
# 180 bits per block each TTI (1ms) x 100 blocks = 18000 bits per TTI (1ms)
# Number of sub-carriers = 12
MAC_packet_size = int(18000/12) # max bits per TTI divided by number of sub-carriers
transmission_bit_limit_per_tti = 18000
BER_baseline = 0.2 # Network Bit Error Rate baseline
retransmission_limit = 6 # Network packet retransmission limit
packet_duplication = 4 # Network packet duplication
effective_delay_budget = 300 # effective packet delay budget of 300ms for LTE
min_IP_packet_size = 100
max_IP_packet_size = 1000

#-------------- Base Classes --------------

def responsify(status,message,data={}):
    code = int(status)
    a_dict = {&quot;data&quot;:data,&quot;message&quot;:message,&quot;code&quot;:code}
    try:
        return Response(json.dumps(a_dict), status=code, mimetype='application/json')
    except:
        return Response(str(a_dict), status=code, mimetype='application/json')

def now(): return datetime.datetime.today()

def ms_elapsed(t): return int(1000*(now() - t).total_seconds())

def Id():
    hasher = md5(); hasher.update(str(now()).encode('utf-8'))
    return hasher.hexdigest()

def is_transcoding_error(noise_level):
    # cell loading increases the bit error rate
    return noise_level &amp;lt; BER_baseline

def IP_Packet(sessionId, size, source, time):
    # This function returns an IP Packet
    return {
        &quot;sessionId&quot; : sessionId,
        &quot;header&quot; : [size, source, time, 0, 0],
        &quot;payload_bits&quot; : &quot;&quot;.join([str(int(random()*2)) for i in range(size)])
    }

def MAC2IPSession(MAC_packet):
    # this function converts a MAC packet back to an IP session for retransmission
    session_time = now()
    IP_packet = IP_Packet(MAC_packet[&quot;sessionId&quot;], MAC_packet[&quot;header&quot;][8], MAC_packet[&quot;header&quot;][1], session_time)
    IP_packet[&quot;header&quot;][3] += MAC_packet[&quot;header&quot;][0]  # add retransmission delay
    IP_packet[&quot;header&quot;][4] = MAC_packet[&quot;header&quot;][4]  # update retransmissions
    IP_packet[&quot;payload_bits&quot;] = MAC_packet[&quot;header&quot;][3]
    return [MAC_packet[&quot;header&quot;][1], session_time, IP_packet[&quot;sessionId&quot;], 1, duplicate([IP_packet], packet_duplication)]

def MAC_Packet(sessionId, trans_bits, source, delay, source_bits, retransmissions, packetId, packet_index, n_mac_packets, size):
    # this function returns a MAC packet
    return {
        &quot;sessionId&quot; : sessionId,
        &quot;header&quot; : [delay, source, now(), source_bits, retransmissions, packetId, packet_index, n_mac_packets, size],
        &quot;payload_bits&quot; : trans_bits
    }

def transcode_bits(bits, plan):
    # this is the bit transcoding function that copies bits from an IP packet stream into a new MAC packet
    noise_level = random()*random()  # random MAC noise level during transcoding
    field = [x for x in bits]
    bands = []
    for size in plan:
        source = []; trans = []
        for i in range(size):
            bit = field.pop(0) # preserve bit order
            source.append(bit)
            # bit error will occur if cell load increases baseline BER above current noise level
            if is_transcoding_error(noise_level):
                trans.append(str(abs(int(float(bit)-1))))
            else:
                trans.append(bit)
        bands.append([&quot;&quot;.join(source), &quot;&quot;.join(trans)])
    return bands

def transcoding_plan(x, b):
    # function for creating a plan to split a bit stream into smaller streams that are not greater than the MAC packet size
    divs = x // b
    rem = x % b
    if divs:
        if rem:
            return [b for i in range(divs)]+[rem]
        else:
            return [b for i in range(divs)]
    else:
        return [x]

def packet_size():
    # returns an initial random size for an IP packet
    return int(min_IP_packet_size + random()*(max_IP_packet_size - min_IP_packet_size))

def duplicate(array, n):
    # function to duplicate the IP packets n times given the original array
    container = []
    for obj in array:
        for i in range(n):
            container.append(obj)
    return container

def UESession(ip_address, n_packets):
    # authenticates a UE and creates a session to handle the IP packet uplink
    sessionId = Id()
    session_time = now()
    return [ip_address, session_time, sessionId, n_packets, duplicate([IP_Packet(sessionId, packet_size(), ip_address, session_time) for i in range(n_packets)], packet_duplication)]

def NetworkDataManager(netbuffer_host_dir):
    global NETWORK_DATA
    NETWORK_DATA[netbuffer_host_dir] = {}
    return NETWORK_DATA[netbuffer_host_dir]

def register_new_netbuffer(netbuffer_host_dir, netbuffer_type, container):
    global NETWORK_DATA
    NETWORK_DATA[netbuffer_host_dir][netbuffer_type] = container;

def write_netbuffer(netbuffer_host_dir, netbuffer_type, data):
    global NETWORK_DATA
    if netbuffer_type not in NETWORK_DATA[netbuffer_host_dir]:
        register_new_netbuffer(netbuffer_host_dir, netbuffer_type, None)
    NETWORK_DATA[netbuffer_host_dir][netbuffer_type] = data;
    return data

def read_netbuffer(netbuffer_host_dir, netbuffer_type):
    try:
        if netbuffer_type in NETWORK_DATA[netbuffer_host_dir]:
            return NETWORK_DATA[netbuffer_host_dir][netbuffer_type]
        else:
            return None
    except:
        return None

def reset_network():
    global NETWORK_DATA, Transmission
    Transmission = {
        &quot;RR&quot; : { &quot;locked&quot; : None, &quot;packets&quot; : [], &quot;data&quot; : [], &quot;size&quot; : 0 },
        &quot;PF&quot; : { &quot;locked&quot; : None, &quot;packets&quot; : [], &quot;data&quot; : [], &quot;size&quot; : 0 },
        &quot;NV&quot; : { &quot;locked&quot; : None, &quot;packets&quot; : [], &quot;data&quot; : [], &quot;size&quot; : 0 }
    }
    write_netbuffer(&quot;AirInterface&quot;, &quot;UERegister&quot;, [])
    write_netbuffer(&quot;PhysicalUplinkControlChannel&quot;, &quot;QueuedMACPackets&quot;, [])
    write_netbuffer(&quot;MAC&quot;, &quot;TransmissionQueue&quot;, [])
    write_netbuffer(&quot;MAC&quot;, &quot;RejectedPackets&quot;, [])
    write_netbuffer(&quot;Scheduler&quot;, &quot;SortedPackets&quot;, {})
    return 200

def safely_divide(a, b):
    try:
        return a/b
    except:
        return 1

def zero2one(x):
    if x == 0:
        return 1
    else:
        return x

def CQI_Prioritization(packets, default=True):
    '''
        Factors considered include: packet size, packet delay and retransmissions. 
        Emphasis is on maximizing throughput by sending the highest quality packets.
        Larger packets with smaller delays and lower retransmission rates are prioritized. 
        Formula used: CQI = log10(packet_size) + log10(packet_delay_budget/packet_delay) + log10(retransmissions/max_retransmissions)
    '''
    def calc_CQI(packet):
        # logarithm of CQI
        if default:
            cqi = log10(zero2one(packet[&quot;header&quot;][8])) + log10(zero2one(safely_divide(effective_delay_budget, packet[&quot;header&quot;][0]))) + log10(zero2one(safely_divide(packet[&quot;header&quot;][4], retransmission_limit)))
        else:
            cqi = log10(zero2one(packet[&quot;header&quot;][8])) - log10(zero2one(safely_divide(effective_delay_budget, packet[&quot;header&quot;][0]))) - log10(zero2one(safely_divide(packet[&quot;header&quot;][4], retransmission_limit)))
        return cqi 
    CQIs = [calc_CQI(packet) for packet in packets];
    CQIs_ = [calc_CQI(packet) for packet in packets];
    CQIs_.sort()
    CQIs_.reverse()
    prioritized = [packets[CQIs.index(CQI)] for CQI in CQIs_];
    return prioritized

def log(sessionId, request, response):
    # this is the logging function that produces color-coded records of events that occur in the network
    def format():
        colorMap = {
            &quot;IP_PACKETS_RECEIVED&quot;: &quot;yellow&quot;,
            &quot;MAC_PACKETS_MODULATED&quot;: &quot;cyan&quot;,
            &quot;RETRANSMITTED_PACKET&quot;: &quot;orange&quot;,
            &quot;QUEUED_PACKET&quot;: &quot;green&quot;,
            &quot;REJECTED_PACKET&quot;: &quot;red&quot;,
            &quot;SORTED_PACKET&quot;: &quot;pink&quot;,
            &quot;SCHEDULER_EMPTY_STATE&quot; : &quot;yellow&quot;,
            &quot;SCHEDULER_ALLOCATED_STATE&quot; : &quot;cyan&quot;,
            &quot;SCHEDULED_PACKETS&quot; : &quot;orange&quot;
        }
        return str(now()), sessionId, colorMap[request], request, response
    Log = read_netbuffer(&quot;NetLog&quot;, &quot;log&quot;)
    if Log:
        Log.append(format())
    else:
        Log = [format()]
    write_netbuffer(&quot;NetLog&quot;, &quot;log&quot;, Log)
    return None

#-------------- Component Data Models --------------

AirInterface = NetworkDataManager(&quot;AirInterface&quot;) # Handles initial packets entering the network
PhysicalUplinkControlChannel = NetworkDataManager(&quot;PhysicalUplinkControlChannel&quot;) # Modulates IP packets to MAC packets
MAC = NetworkDataManager(&quot;MAC&quot;) # validates packets and handles retransmissions or queueing of verified packets
Scheduler = NetworkDataManager(&quot;Scheduler&quot;) # sorts verified packets and schedules transmission of packets
Transmission = {
        &quot;RR&quot; : { &quot;locked&quot; : None, &quot;packets&quot; : [], &quot;data&quot; : [], &quot;size&quot; : 0 },
        &quot;PF&quot; : { &quot;locked&quot; : None, &quot;packets&quot; : [], &quot;data&quot; : [], &quot;size&quot; : 0 },
        &quot;NV&quot; : { &quot;locked&quot; : None, &quot;packets&quot; : [], &quot;data&quot; : [], &quot;size&quot; : 0 }
}
register_new_netbuffer(&quot;AirInterface&quot;, &quot;UERegister&quot;, [])
register_new_netbuffer(&quot;PhysicalUplinkControlChannel&quot;, &quot;QueuedMACPackets&quot;, [])
register_new_netbuffer(&quot;MAC&quot;, &quot;TransmissionQueue&quot;, [])
register_new_netbuffer(&quot;MAC&quot;, &quot;RejectedPackets&quot;, [])
register_new_netbuffer(&quot;Scheduler&quot;, &quot;SortedPackets&quot;, {})

def transmit(locked, scheduler, packet):
    # transmits and terminates scheduled packets
    global Transmission
    scheduler_delay = ms_elapsed(packet[&quot;header&quot;][-1]);
    matching_index = None
    if (len(Transmission[scheduler][&quot;data&quot;]) == 0):
        Transmission[scheduler][&quot;data&quot;].append({
            &quot;sessionId&quot; : locked,
            &quot;QoS&quot; : {
                 &quot;packets_received&quot; : 1,
                 &quot;total_packet_delay&quot; : packet[&quot;header&quot;][0],
                 &quot;total_retransmissions&quot; : packet[&quot;header&quot;][4],
                 &quot;total_scheduler_delay&quot; : scheduler_delay,
                 &quot;total_packet_size&quot; : packet[&quot;header&quot;][8]
            }
        })
    else:
        matching = [Transmission[scheduler][&quot;data&quot;].index(data) for data in Transmission[scheduler][&quot;data&quot;] if data[&quot;sessionId&quot;] == locked]
        if matching:
            matching_index = matching[0];
            Transmission[scheduler][&quot;data&quot;][matching_index][&quot;QoS&quot;][&quot;packets_received&quot;]+=1
            Transmission[scheduler][&quot;data&quot;][matching_index][&quot;QoS&quot;][&quot;total_packet_delay&quot;]+=packet[&quot;header&quot;][0]
            Transmission[scheduler][&quot;data&quot;][matching_index][&quot;QoS&quot;][&quot;total_retransmissions&quot;]+=packet[&quot;header&quot;][4]
            Transmission[scheduler][&quot;data&quot;][matching_index][&quot;QoS&quot;][&quot;total_scheduler_delay&quot;]+=scheduler_delay
            Transmission[scheduler][&quot;data&quot;][matching_index][&quot;QoS&quot;][&quot;total_packet_size&quot;] += packet[&quot;header&quot;][8]
        else:
            Transmission[scheduler][&quot;data&quot;].append({
                &quot;sessionId&quot; : locked,
                &quot;QoS&quot; : {
                     &quot;packets_received&quot; : 1,
                     &quot;total_packet_delay&quot; : packet[&quot;header&quot;][0],
                     &quot;total_retransmissions&quot; : packet[&quot;header&quot;][4],
                     &quot;total_scheduler_delay&quot; : scheduler_delay,
                     &quot;total_packet_size&quot; : packet[&quot;header&quot;][8]
                }
            })
    Transmission[scheduler][&quot;size&quot;] += packet[&quot;header&quot;][8]
    return 200

NetLog = NetworkDataManager(&quot;NetLog&quot;) # records events in the network

#-------------- Network Endpoints --------------

# inspect data structures
@app.route(&quot;/SubNetworkLTE/Internal/Inspect/&amp;lt;path:section&amp;gt;&quot;)
def InspectData(section):
    payload = {
        &quot;UERegister&quot; : read_netbuffer(&quot;AirInterface&quot;, &quot;UERegister&quot;),
        &quot;QueuedMACPackets&quot; : read_netbuffer(&quot;PhysicalUplinkControlChannel&quot;, &quot;QueuedMACPackets&quot;),
        &quot;TransmissionQueue&quot; : read_netbuffer(&quot;MAC&quot;, &quot;TransmissionQueue&quot;),
        &quot;RejectedPackets&quot; : read_netbuffer(&quot;MAC&quot;, &quot;RejectedPackets&quot;),
        &quot;SortedPackets&quot; : read_netbuffer(&quot;Scheduler&quot;, &quot;SortedPackets&quot;),
        &quot;Transmission&quot; : Transmission
    }
    if section == &quot;all&quot;:
        selection = payload
    else:
        selection = payload[section]
    return responsify(200, &quot;%s data attached&quot; % section, selection)

# Reset
@app.route(&quot;/SubNetworkLTE/Reset&quot;)
def Reset():
    return str(reset_network())

# schedule packets
@app.route(&quot;/SubNetworkLTE/Scheduler/Schedule&quot;)
def SchedulePackets():
    global Transmission, scheduler_events
    def Schedule(scheduler):
        locked = Transmission[scheduler][&quot;locked&quot;]
        packets = Transmission[scheduler][&quot;packets&quot;]
        if scheduler == &quot;RR&quot;:
            # check size constraint
            total_size = sum([packet[&quot;header&quot;][-2] for packet in packets]);
            if (total_size &amp;lt;= transmission_bit_limit_per_tti):
                # send all packets on FIFO basis
                group = packets[::-1]; group_size = total_size
                process = [transmit(locked, scheduler, packet) for packet in group];
            else:
                # audit and send on FIFO basis
                while len(packets) &amp;gt; 0:
                    group = []; group_size = 0; proceed = True
                    while (group_size &amp;lt;= transmission_bit_limit_per_tti and proceed):
                        if len(packets) &amp;gt; 0:
                            packet = packets.pop()
                            group_size += packet[&quot;header&quot;][-2]
                            group.append(packet)
                        else:
                            proceed = False
                    # send group
                    process = [transmit(locked, scheduler, packet) for packet in group];
        if scheduler == &quot;PF&quot;:
            # packet CQI Prioritization
            packets = CQI_Prioritization(packets);
            # check size constraint
            total_size = sum([packet[&quot;header&quot;][-2] for packet in packets]);
            if (total_size &amp;lt;= transmission_bit_limit_per_tti):
                # send all packets after CQI prioritization
                group = packets; group_size = total_size
                process = [transmit(locked, scheduler, packet) for packet in group];
            else:
                # audit and send on CQI basis
                while len(packets) &amp;gt; 0:
                    group = []; group_size = 0; proceed = True
                    while (group_size &amp;lt;= transmission_bit_limit_per_tti and proceed):
                        if len(packets) &amp;gt; 0:
                            packet = packets.pop(0)
                            group_size += packet[&quot;header&quot;][-2]
                            group.append(packet)
                        else:
                            proceed = False
                    # send group
                    process = [transmit(locked, scheduler, packet) for packet in group];
        if scheduler == &quot;NV&quot;:
            # packet CQI Prioritization (size only)
            packets = CQI_Prioritization(packets, False)
            # check size constraint
            total_size = sum([packet[&quot;header&quot;][-2] for packet in packets])
            if (total_size &amp;lt;= transmission_bit_limit_per_tti):
                # send all packets after CQI prioritization
                group = packets
                group_size = total_size
                process = [transmit(locked, scheduler, packet) for packet in group]
            else:
                # audit and send on CQI basis
                while len(packets) &amp;gt; 0:
                    group = []
                    group_size = 0
                    proceed = True
                    while (group_size &amp;lt;= transmission_bit_limit_per_tti and proceed):
                        if len(packets) &amp;gt; 0:
                            packet = packets.pop(0)
                            group_size += packet[&quot;header&quot;][-2]
                            group.append(packet)
                        else:
                            proceed = False
                    # send group
                    process = [transmit(locked, scheduler, packet) for packet in group]
        log(locked, &quot;SCHEDULED_PACKETS&quot;, &quot;%s packets with total size: %s bits were scheduled by: %s&quot; % (len(group), group_size, scheduler))
        return &quot;%s: %s&quot; % (200, &quot;Packets were scheduled (%s bits)&quot; % group_size)
    def isolate_free_MAC_packets(isolated=None):
        SortedPackets = read_netbuffer(&quot;Scheduler&quot;, &quot;SortedPackets&quot;);
        if not isolated:
            packets = [];
            for sessionId in SortedPackets:
                if not SortedPackets[sessionId][&quot;busy&quot;]:
                    isolated = sessionId
                    SortedPackets[sessionId][&quot;busy&quot;] = True;  # lock this queue
                    break;
        try:
            # detach packets
            packets = SortedPackets[isolated][&quot;packets&quot;]
            SortedPackets[isolated][&quot;packets&quot;] = []
        except:
            pass
        # update SortedPackets
        write_netbuffer(&quot;Scheduler&quot;, &quot;SortedPackets&quot;, SortedPackets);
        return isolated, packets
    try:
        scheduler_events+=1
        schedulers = [&quot;RR&quot;, &quot;PF&quot;, &quot;NV&quot;]
        scheduler = schedulers[scheduler_events % len(schedulers)]
        # allocation
        locked, packets = isolate_free_MAC_packets()
        # register on Transmission
        Transmission[scheduler][&quot;locked&quot;] = locked
        Transmission[scheduler][&quot;packets&quot;] = packets
        log(locked, &quot;SCHEDULER_ALLOCATED_STATE&quot;, &quot;Scheduler: %s has been allocated %s packets&quot; % (scheduler, len(packets)))
        return Schedule(scheduler)
    except Exception as e:
        print(&quot;Error @ scheduler : %s&quot; % str(e))
        return &quot;%s: %s&quot; % (400, str(e))

# simulation agent firing mechanism for returning activity logs
@app.route(&quot;/SubNetworkLTE/NetLog&quot;)
def ShowActivity():
    Log = read_netbuffer(&quot;NetLog&quot;, &quot;log&quot;)
    if Log:
        html = '&amp;lt;html&amp;gt;&amp;lt;meta http-equiv=&quot;refresh&quot; content=&quot;5&quot;&amp;gt;&amp;lt;body bgcolor=&quot;black&quot;&amp;gt;&amp;lt;div style=&quot;color: white; font-family: consolas; font-size:12;&quot;&amp;gt;%s&amp;lt;/div&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;'
        spool = &quot;&quot;; count = -1
        for log in Log[::-1]:
            count+=1
            spool += '&amp;lt;p&amp;gt;&amp;lt;b&amp;gt;%s --&amp;gt; &amp;lt;/b&amp;gt;[%s] &amp;lt;span style=&quot;color: %s;&quot;&amp;gt;[%s]&amp;lt;/span&amp;gt; [%s]' % log + ' (#%s)&amp;lt;/p&amp;gt;' % str(len(Log) - count)
        return html % spool
    else:
        return &quot;%s: %s&quot; % (404, &quot;No activity logs found&quot;)

# simulation agent firing mechanism for sorting verified packets
@app.route(&quot;/SubNetworkLTE/Scheduler/Sorter&quot;)
def SortPackets():
    try:
        TransmissionQueue = read_netbuffer(&quot;MAC&quot;, &quot;TransmissionQueue&quot;)
        packet = TransmissionQueue.pop()  # release a MAC packet
        # add scheduler start
        packet[&quot;header&quot;].append(now())
        write_netbuffer(&quot;MAC&quot;, &quot;TransmissionQueue&quot;, TransmissionQueue)
        sessionId = packet[&quot;sessionId&quot;]
        SortedPackets = read_netbuffer(&quot;Scheduler&quot;, &quot;SortedPackets&quot;)
        if SortedPackets:
            if sessionId in SortedPackets:
                SortedPackets[sessionId][&quot;packets&quot;].insert(0, packet)
            else:
                SortedPackets[sessionId] = { &quot;busy&quot; : False, &quot;packets&quot; : [packet] }
        else:
            SortedPackets = {sessionId: { &quot;busy&quot; : False, &quot;packets&quot; : [packet] }}
        write_netbuffer(&quot;Scheduler&quot;, &quot;SortedPackets&quot;, SortedPackets)
        log(sessionId, &quot;SORTED_PACKET&quot;, &quot;1 packet with id: %s was sorted (%s bits)&quot; % (packet[&quot;header&quot;][5], packet[&quot;header&quot;][8]))
        return &quot;%s: %s&quot; % (201, &quot;Packet was sorted (%s bits)&quot; % packet[&quot;header&quot;][8])
    except Exception as e:
        print(&quot;Error @ sorter : %s&quot; % str(e))
        return &quot;%s: %s&quot; % (404, &quot;No packet found&quot;)

# simulation agent firing mechanism for validating packet integrity
@app.route(&quot;/SubNetworkLTE/MAC/Profiler&quot;)
def ProfilePackets():
    def retransmit(packet):
        # check if retransmission_limit reached
        if packet[&quot;header&quot;][4] + 1 &amp;gt; retransmission_limit:
            # reject this MAC packet
            RejectedPackets = read_netbuffer(&quot;MAC&quot;, &quot;RejectedPackets&quot;)
            if RejectedPackets:
                RejectedPackets.append(packet)
            else:
                RejectedPackets = [packet]
            write_netbuffer(&quot;MAC&quot;, &quot;RejectedPackets&quot;, RejectedPackets)
            log(packet[&quot;sessionId&quot;], &quot;REJECTED_PACKET&quot;, &quot;1 packet with id: %s was rejected (%s bits)&quot; % (packet[&quot;header&quot;][5], packet[&quot;header&quot;][8]))
            return &quot;%s: %s&quot; % (204, &quot;Packet was rejected (%s bits)&quot; % packet[&quot;header&quot;][8])
        else:
            packet[&quot;header&quot;][4]+=1
            retransmitted_session = MAC2IPSession(packet) # convert MAC packet back to IP session
            UERegister = read_netbuffer(&quot;AirInterface&quot;, &quot;UERegister&quot;)
            if UERegister:
                UERegister.append(retransmitted_session)  # lower priority for unvalidated retransmitted packets
            else:
                UERegister = [retransmitted_session]
            write_netbuffer(&quot;AirInterface&quot;, &quot;UERegister&quot;, UERegister) # retransmit IP session
            log(packet[&quot;sessionId&quot;], &quot;RETRANSMITTED_PACKET&quot;, &quot;1 packet with id: %s was retransmitted (%s bits)&quot; % (packet[&quot;header&quot;][5], packet[&quot;header&quot;][8]))
            return &quot;%s: %s&quot; % (200, &quot;Packet was retransmitted (%s bits)&quot; % packet[&quot;header&quot;][8])
    def queue(packet):
        TransmissionQueue = read_netbuffer(&quot;MAC&quot;, &quot;TransmissionQueue&quot;)
        if TransmissionQueue:
            TransmissionQueue.insert(0, packet)  # FIFO
        else:
            TransmissionQueue = [packet]
        write_netbuffer(&quot;MAC&quot;, &quot;TransmissionQueue&quot;, TransmissionQueue) # queue this transmittable MAC packet
        log(packet[&quot;sessionId&quot;], &quot;QUEUED_PACKET&quot;, &quot;1 packet with id: %s was queued (%s bits)&quot; % (packet[&quot;header&quot;][5], packet[&quot;header&quot;][8]))
        return &quot;%s: %s&quot; % (201, &quot;Packet was queued (%s bits)&quot; % packet[&quot;header&quot;][8])
    try:
        QueuedMACPackets = read_netbuffer(&quot;PhysicalUplinkControlChannel&quot;, &quot;QueuedMACPackets&quot;)
        packet = QueuedMACPackets.pop() # release a MAC packet
        write_netbuffer(&quot;PhysicalUplinkControlChannel&quot;, &quot;QueuedMACPackets&quot;, QueuedMACPackets)
        # test MAC packet for errors, handle contextually
        if packet[&quot;payload_bits&quot;] == packet[&quot;header&quot;][3]:
            return queue(packet)
        else:
            return retransmit(packet)
    except Exception as e:
        print(&quot;Error @ profiler : %s&quot; % str(e))
        return &quot;%s: %s&quot; % (404, &quot;No packet found&quot;)

# simulation agent firing mechanism for transcoding IP packets to MAC packets
@app.route(&quot;/SubNetworkLTE/PhysicalUplinkControlChannel/Modulation&quot;)
def ModulatePackets():
    session = None
    UERegister = read_netbuffer(&quot;AirInterface&quot;, &quot;UERegister&quot;)
    if UERegister:
        session = UERegister.pop()
        write_netbuffer(&quot;AirInterface&quot;, &quot;UERegister&quot;, UERegister)
        ip_address, session_time, sessionId, n_packets, ip_packets_loggable = session
        ip_packets = [log for log in ip_packets_loggable]
        # Packet Modulation
        delay = ms_elapsed(session_time); modulated = 0
        for packet in ip_packets:
            delay+=packet[&quot;header&quot;][3]  # add retransmission delay
            mod_started = now()
            MAC_packets = []
            packetId = Id()
            field = transcode_bits(packet[&quot;payload_bits&quot;], transcoding_plan(packet[&quot;header&quot;][0], MAC_packet_size))
            packet_index = -1
            for band in field:
                packet_index+=1
                source_bits, trans_bits = band
                mod_delay = ms_elapsed(mod_started); delay+=mod_delay # add modulation delay
                # FIFO Queue, preserve retransmissions
                MAC_packets.insert(0, MAC_Packet(sessionId, trans_bits, ip_address, delay, source_bits, packet[&quot;header&quot;][4], packetId, packet_index, len(field), len(trans_bits)))
            modulated+=len(MAC_packets)
            QueuedMACPackets = read_netbuffer(&quot;PhysicalUplinkControlChannel&quot;, &quot;QueuedMACPackets&quot;)
            if QueuedMACPackets:
                QueuedMACPackets = MAC_packets + QueuedMACPackets # ensure FIFO
            else:
                QueuedMACPackets = MAC_packets
            write_netbuffer(&quot;PhysicalUplinkControlChannel&quot;, &quot;QueuedMACPackets&quot;, QueuedMACPackets)
            log(sessionId, &quot;MAC_PACKETS_MODULATED&quot;, &quot;%s MAC packets from session %s delayed %sms&quot; % (len(MAC_packets), sessionId, mod_delay))
        return &quot;%s: %s&quot; % (200, &quot;Successfully modulated %s packets&quot; % modulated)
    else:
        return &quot;%s: %s&quot; % (404, &quot;No session found&quot;)

# simulation agent firing mechanism for authenticating UE sessions and receiving IP packets
@app.route(&quot;/SubNetworkLTE/AirInterface/UERegistration/&amp;lt;path:n_packets&amp;gt;&quot;)
def UERegistration(n_packets):
    ip_address = request.remote_addr
    try:
        session = UESession(ip_address, int(n_packets))
    except Exception as e:
        print(&quot;Error @ create_session : %s&quot; % str(e))
        return &quot;%s: %s&quot; % (400, &quot;Error creating session: packet_size not specified&quot;)
    UERegister = read_netbuffer(&quot;AirInterface&quot;, &quot;UERegister&quot;)
    if UERegister:
        UERegister.insert(0, session)  #FIFO Queue
    else:
        UERegister = [session]
    write_netbuffer(&quot;AirInterface&quot;, &quot;UERegister&quot;, UERegister)
    log(session[2], &quot;IP_PACKETS_RECEIVED&quot;, 'UE at &amp;lt;span style=&quot;color: cyan;&quot;&amp;gt;%s&amp;lt;/span&amp;gt; sent %s IP packets of %s bits' % (ip_address, n_packets, sum([this_packet[&quot;header&quot;][0] for this_packet in session[4]])))
    return &quot;%s: %s&quot; % (200, &quot;Successfully registered %s packets&quot; % n_packets)

if __name__ == &quot;__main__&quot;:
    app.run(host=server_host, port=server_port, threaded=True)
</code></pre>" style="border: 0px; display: block;font-family: Consolas, Inconsolata, Courier, monospace; font-weight: bold; white-space: pre; margin: 0px;border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; word-wrap: break-word; border: 1px solid rgb(204, 204, 204); padding: 0px 5px; margin: 0px 2px;font-size: 1em; letter-spacing: -1px; font-weight: bold;"><span class="hljs-comment" style="color: rgb(147, 161, 161);">#============== Python3 Flask Model of LTE Sub Network ==============</span>

<span class="hljs-comment" style="color: rgb(147, 161, 161);">#   Version: 1.00</span>
<span class="hljs-comment" style="color: rgb(147, 161, 161);">#   Author: Monty Dimkpa</span>

<span class="hljs-comment" style="color: rgb(147, 161, 161);">#====================================================================</span>


<span class="hljs-comment" style="color: rgb(147, 161, 161);">#-------------- Importing required Python libraries --------------</span>

<span class="hljs-keyword" style="color: rgb(133, 153, 0);">from</span> flask <span class="hljs-keyword" style="color: rgb(133, 153, 0);">import</span> Flask, request, render_template, Response
<span class="hljs-keyword" style="color: rgb(133, 153, 0);">from</span> flask_cors <span class="hljs-keyword" style="color: rgb(133, 153, 0);">import</span> CORS
<span class="hljs-keyword" style="color: rgb(133, 153, 0);">import</span> sys
<span class="hljs-keyword" style="color: rgb(133, 153, 0);">import</span> os
<span class="hljs-keyword" style="color: rgb(133, 153, 0);">import</span> json
<span class="hljs-keyword" style="color: rgb(133, 153, 0);">from</span> random <span class="hljs-keyword" style="color: rgb(133, 153, 0);">import</span> random
<span class="hljs-keyword" style="color: rgb(133, 153, 0);">import</span> datetime
<span class="hljs-keyword" style="color: rgb(133, 153, 0);">from</span> hashlib <span class="hljs-keyword" style="color: rgb(133, 153, 0);">import</span> md5
<span class="hljs-keyword" style="color: rgb(133, 153, 0);">from</span> math <span class="hljs-keyword" style="color: rgb(133, 153, 0);">import</span> log10

app = Flask(__name__)
cors = CORS(app, resources={<span class="hljs-string" style="color: rgb(42, 161, 152);">r"/*"</span>: {<span class="hljs-string" style="color: rgb(42, 161, 152);">"origins"</span>: <span class="hljs-string" style="color: rgb(42, 161, 152);">"*"</span>}})

<span class="hljs-keyword" style="color: rgb(133, 153, 0);">global</span> server_host, server_port, scheduler_events, empty_retry_limit, MAC_packet_size, transmission_bit_limit_per_tti,\
       BER_baseline, retransmission_limit, packet_duplication, effective_delay_budget, min_IP_packet_size, max_IP_packet_size,\
       Transmission, NETWORK_DATA

<span class="hljs-comment" style="color: rgb(147, 161, 161);">#-------------- Network Initialization Parameters --------------</span>

server_host = <span class="hljs-string" style="color: rgb(42, 161, 152);">"localhost"</span>
server_port = <span class="hljs-number" style="color: rgb(42, 161, 152);">5000</span>
scheduler_events = <span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>
NETWORK_DATA = {}

<span class="hljs-comment" style="color: rgb(147, 161, 161);">#-------------- LTE Network Constants ------</span>

<span class="hljs-comment" style="color: rgb(147, 161, 161);"># Transmission Bandwidth = 20MHz</span>
<span class="hljs-comment" style="color: rgb(147, 161, 161);"># Number of RBs = 100 blocks</span>
<span class="hljs-comment" style="color: rgb(147, 161, 161);"># RB Frequency = 180KHz</span>
<span class="hljs-comment" style="color: rgb(147, 161, 161);"># 180 bits per block each TTI (1ms) x 100 blocks = 18000 bits per TTI (1ms)</span>
<span class="hljs-comment" style="color: rgb(147, 161, 161);"># Number of sub-carriers = 12</span>
MAC_packet_size = int(<span class="hljs-number" style="color: rgb(42, 161, 152);">18000</span>/<span class="hljs-number" style="color: rgb(42, 161, 152);">12</span>) <span class="hljs-comment" style="color: rgb(147, 161, 161);"># max bits per TTI divided by number of sub-carriers</span>
transmission_bit_limit_per_tti = <span class="hljs-number" style="color: rgb(42, 161, 152);">18000</span>
BER_baseline = <span class="hljs-number" style="color: rgb(42, 161, 152);">0.2</span> <span class="hljs-comment" style="color: rgb(147, 161, 161);"># Network Bit Error Rate baseline</span>
retransmission_limit = <span class="hljs-number" style="color: rgb(42, 161, 152);">6</span> <span class="hljs-comment" style="color: rgb(147, 161, 161);"># Network packet retransmission limit</span>
packet_duplication = <span class="hljs-number" style="color: rgb(42, 161, 152);">4</span> <span class="hljs-comment" style="color: rgb(147, 161, 161);"># Network packet duplication</span>
effective_delay_budget = <span class="hljs-number" style="color: rgb(42, 161, 152);">300</span> <span class="hljs-comment" style="color: rgb(147, 161, 161);"># effective packet delay budget of 300ms for LTE</span>
min_IP_packet_size = <span class="hljs-number" style="color: rgb(42, 161, 152);">100</span>
max_IP_packet_size = <span class="hljs-number" style="color: rgb(42, 161, 152);">1000</span>

<span class="hljs-comment" style="color: rgb(147, 161, 161);">#-------------- Base Classes --------------</span>

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">responsify</span><span class="hljs-params">(status,message,data={})</span>:</span>
    code = int(status)
    a_dict = {<span class="hljs-string" style="color: rgb(42, 161, 152);">"data"</span>:data,<span class="hljs-string" style="color: rgb(42, 161, 152);">"message"</span>:message,<span class="hljs-string" style="color: rgb(42, 161, 152);">"code"</span>:code}
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">try</span>:
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> Response(json.dumps(a_dict), status=code, mimetype=<span class="hljs-string" style="color: rgb(42, 161, 152);">'application/json'</span>)
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">except</span>:
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> Response(str(a_dict), status=code, mimetype=<span class="hljs-string" style="color: rgb(42, 161, 152);">'application/json'</span>)

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">now</span><span class="hljs-params">()</span>:</span> <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> datetime.datetime.today()

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">ms_elapsed</span><span class="hljs-params">(t)</span>:</span> <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> int(<span class="hljs-number" style="color: rgb(42, 161, 152);">1000</span>*(now() - t).total_seconds())

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">Id</span><span class="hljs-params">()</span>:</span>
    hasher = md5(); hasher.update(str(now()).encode(<span class="hljs-string" style="color: rgb(42, 161, 152);">'utf-8'</span>))
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> hasher.hexdigest()

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">is_transcoding_error</span><span class="hljs-params">(noise_level)</span>:</span>
    <span class="hljs-comment" style="color: rgb(147, 161, 161);"># cell loading increases the bit error rate</span>
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> noise_level &lt; BER_baseline

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">IP_Packet</span><span class="hljs-params">(sessionId, size, source, time)</span>:</span>
    <span class="hljs-comment" style="color: rgb(147, 161, 161);"># This function returns an IP Packet</span>
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> {
        <span class="hljs-string" style="color: rgb(42, 161, 152);">"sessionId"</span> : sessionId,
        <span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span> : [size, source, time, <span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>, <span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>],
        <span class="hljs-string" style="color: rgb(42, 161, 152);">"payload_bits"</span> : <span class="hljs-string" style="color: rgb(42, 161, 152);">""</span>.join([str(int(random()*<span class="hljs-number" style="color: rgb(42, 161, 152);">2</span>)) <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> i <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> range(size)])
    }

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">MAC2IPSession</span><span class="hljs-params">(MAC_packet)</span>:</span>
    <span class="hljs-comment" style="color: rgb(147, 161, 161);"># this function converts a MAC packet back to an IP session for retransmission</span>
    session_time = now()
    IP_packet = IP_Packet(MAC_packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"sessionId"</span>], MAC_packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">8</span>], MAC_packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">1</span>], session_time)
    IP_packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">3</span>] += MAC_packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>]  <span class="hljs-comment" style="color: rgb(147, 161, 161);"># add retransmission delay</span>
    IP_packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">4</span>] = MAC_packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">4</span>]  <span class="hljs-comment" style="color: rgb(147, 161, 161);"># update retransmissions</span>
    IP_packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"payload_bits"</span>] = MAC_packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">3</span>]
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> [MAC_packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">1</span>], session_time, IP_packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"sessionId"</span>], <span class="hljs-number" style="color: rgb(42, 161, 152);">1</span>, duplicate([IP_packet], packet_duplication)]

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">MAC_Packet</span><span class="hljs-params">(sessionId, trans_bits, source, delay, source_bits, retransmissions, packetId, packet_index, n_mac_packets, size)</span>:</span>
    <span class="hljs-comment" style="color: rgb(147, 161, 161);"># this function returns a MAC packet</span>
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> {
        <span class="hljs-string" style="color: rgb(42, 161, 152);">"sessionId"</span> : sessionId,
        <span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span> : [delay, source, now(), source_bits, retransmissions, packetId, packet_index, n_mac_packets, size],
        <span class="hljs-string" style="color: rgb(42, 161, 152);">"payload_bits"</span> : trans_bits
    }

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">transcode_bits</span><span class="hljs-params">(bits, plan)</span>:</span>
    <span class="hljs-comment" style="color: rgb(147, 161, 161);"># this is the bit transcoding function that copies bits from an IP packet stream into a new MAC packet</span>
    noise_level = random()*random()  <span class="hljs-comment" style="color: rgb(147, 161, 161);"># random MAC noise level during transcoding</span>
    field = [x <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> x <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> bits]
    bands = []
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> size <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> plan:
        source = []; trans = []
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> i <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> range(size):
            bit = field.pop(<span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>) <span class="hljs-comment" style="color: rgb(147, 161, 161);"># preserve bit order</span>
            source.append(bit)
            <span class="hljs-comment" style="color: rgb(147, 161, 161);"># bit error will occur if cell load increases baseline BER above current noise level</span>
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> is_transcoding_error(noise_level):
                trans.append(str(abs(int(float(bit)-<span class="hljs-number" style="color: rgb(42, 161, 152);">1</span>))))
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
                trans.append(bit)
        bands.append([<span class="hljs-string" style="color: rgb(42, 161, 152);">""</span>.join(source), <span class="hljs-string" style="color: rgb(42, 161, 152);">""</span>.join(trans)])
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> bands

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">transcoding_plan</span><span class="hljs-params">(x, b)</span>:</span>
    <span class="hljs-comment" style="color: rgb(147, 161, 161);"># function for creating a plan to split a bit stream into smaller streams that are not greater than the MAC packet size</span>
    divs = x // b
    rem = x % b
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> divs:
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> rem:
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> [b <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> i <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> range(divs)]+[rem]
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> [b <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> i <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> range(divs)]
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> [x]

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">packet_size</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-comment" style="color: rgb(147, 161, 161);"># returns an initial random size for an IP packet</span>
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> int(min_IP_packet_size + random()*(max_IP_packet_size - min_IP_packet_size))

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">duplicate</span><span class="hljs-params">(array, n)</span>:</span>
    <span class="hljs-comment" style="color: rgb(147, 161, 161);"># function to duplicate the IP packets n times given the original array</span>
    container = []
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> obj <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> array:
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> i <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> range(n):
            container.append(obj)
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> container

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">UESession</span><span class="hljs-params">(ip_address, n_packets)</span>:</span>
    <span class="hljs-comment" style="color: rgb(147, 161, 161);"># authenticates a UE and creates a session to handle the IP packet uplink</span>
    sessionId = Id()
    session_time = now()
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> [ip_address, session_time, sessionId, n_packets, duplicate([IP_Packet(sessionId, packet_size(), ip_address, session_time) <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> i <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> range(n_packets)], packet_duplication)]

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">NetworkDataManager</span><span class="hljs-params">(netbuffer_host_dir)</span>:</span>
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">global</span> NETWORK_DATA
    NETWORK_DATA[netbuffer_host_dir] = {}
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> NETWORK_DATA[netbuffer_host_dir]

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">register_new_netbuffer</span><span class="hljs-params">(netbuffer_host_dir, netbuffer_type, container)</span>:</span>
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">global</span> NETWORK_DATA
    NETWORK_DATA[netbuffer_host_dir][netbuffer_type] = container;

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">write_netbuffer</span><span class="hljs-params">(netbuffer_host_dir, netbuffer_type, data)</span>:</span>
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">global</span> NETWORK_DATA
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> netbuffer_type <span class="hljs-keyword" style="color: rgb(133, 153, 0);">not</span> <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> NETWORK_DATA[netbuffer_host_dir]:
        register_new_netbuffer(netbuffer_host_dir, netbuffer_type, <span class="hljs-keyword" style="color: rgb(133, 153, 0);">None</span>)
    NETWORK_DATA[netbuffer_host_dir][netbuffer_type] = data;
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> data

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">read_netbuffer</span><span class="hljs-params">(netbuffer_host_dir, netbuffer_type)</span>:</span>
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">try</span>:
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> netbuffer_type <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> NETWORK_DATA[netbuffer_host_dir]:
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> NETWORK_DATA[netbuffer_host_dir][netbuffer_type]
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> <span class="hljs-keyword" style="color: rgb(133, 153, 0);">None</span>
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">except</span>:
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> <span class="hljs-keyword" style="color: rgb(133, 153, 0);">None</span>

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">reset_network</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">global</span> NETWORK_DATA, Transmission
    Transmission = {
        <span class="hljs-string" style="color: rgb(42, 161, 152);">"RR"</span> : { <span class="hljs-string" style="color: rgb(42, 161, 152);">"locked"</span> : <span class="hljs-keyword" style="color: rgb(133, 153, 0);">None</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"packets"</span> : [], <span class="hljs-string" style="color: rgb(42, 161, 152);">"data"</span> : [], <span class="hljs-string" style="color: rgb(42, 161, 152);">"size"</span> : <span class="hljs-number" style="color: rgb(42, 161, 152);">0</span> },
        <span class="hljs-string" style="color: rgb(42, 161, 152);">"PF"</span> : { <span class="hljs-string" style="color: rgb(42, 161, 152);">"locked"</span> : <span class="hljs-keyword" style="color: rgb(133, 153, 0);">None</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"packets"</span> : [], <span class="hljs-string" style="color: rgb(42, 161, 152);">"data"</span> : [], <span class="hljs-string" style="color: rgb(42, 161, 152);">"size"</span> : <span class="hljs-number" style="color: rgb(42, 161, 152);">0</span> },
        <span class="hljs-string" style="color: rgb(42, 161, 152);">"NV"</span> : { <span class="hljs-string" style="color: rgb(42, 161, 152);">"locked"</span> : <span class="hljs-keyword" style="color: rgb(133, 153, 0);">None</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"packets"</span> : [], <span class="hljs-string" style="color: rgb(42, 161, 152);">"data"</span> : [], <span class="hljs-string" style="color: rgb(42, 161, 152);">"size"</span> : <span class="hljs-number" style="color: rgb(42, 161, 152);">0</span> }
    }
    write_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"AirInterface"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"UERegister"</span>, [])
    write_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"PhysicalUplinkControlChannel"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"QueuedMACPackets"</span>, [])
    write_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"MAC"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"TransmissionQueue"</span>, [])
    write_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"MAC"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"RejectedPackets"</span>, [])
    write_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"Scheduler"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"SortedPackets"</span>, {})
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> <span class="hljs-number" style="color: rgb(42, 161, 152);">200</span>

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">safely_divide</span><span class="hljs-params">(a, b)</span>:</span>
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">try</span>:
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> a/b
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">except</span>:
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> <span class="hljs-number" style="color: rgb(42, 161, 152);">1</span>

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">zero2one</span><span class="hljs-params">(x)</span>:</span>
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> x == <span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>:
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> <span class="hljs-number" style="color: rgb(42, 161, 152);">1</span>
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> x

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">CQI_Prioritization</span><span class="hljs-params">(packets, default=True)</span>:</span>
    <span class="hljs-string" style="color: rgb(42, 161, 152);">'''
        Factors considered include: packet size, packet delay and retransmissions. 
        Emphasis is on maximizing throughput by sending the highest quality packets.
        Larger packets with smaller delays and lower retransmission rates are prioritized. 
        Formula used: CQI = log10(packet_size) + log10(packet_delay_budget/packet_delay) + log10(retransmissions/max_retransmissions)
    '''</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">calc_CQI</span><span class="hljs-params">(packet)</span>:</span>
        <span class="hljs-comment" style="color: rgb(147, 161, 161);"># logarithm of CQI</span>
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> default:
            cqi = log10(zero2one(packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">8</span>])) + log10(zero2one(safely_divide(effective_delay_budget, packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>]))) + log10(zero2one(safely_divide(packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">4</span>], retransmission_limit)))
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
            cqi = log10(zero2one(packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">8</span>])) - log10(zero2one(safely_divide(effective_delay_budget, packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>]))) - log10(zero2one(safely_divide(packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">4</span>], retransmission_limit)))
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> cqi 
    CQIs = [calc_CQI(packet) <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> packet <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> packets];
    CQIs_ = [calc_CQI(packet) <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> packet <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> packets];
    CQIs_.sort()
    CQIs_.reverse()
    prioritized = [packets[CQIs.index(CQI)] <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> CQI <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> CQIs_];
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> prioritized

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">log</span><span class="hljs-params">(sessionId, request, response)</span>:</span>
    <span class="hljs-comment" style="color: rgb(147, 161, 161);"># this is the logging function that produces color-coded records of events that occur in the network</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">format</span><span class="hljs-params">()</span>:</span>
        colorMap = {
            <span class="hljs-string" style="color: rgb(42, 161, 152);">"IP_PACKETS_RECEIVED"</span>: <span class="hljs-string" style="color: rgb(42, 161, 152);">"yellow"</span>,
            <span class="hljs-string" style="color: rgb(42, 161, 152);">"MAC_PACKETS_MODULATED"</span>: <span class="hljs-string" style="color: rgb(42, 161, 152);">"cyan"</span>,
            <span class="hljs-string" style="color: rgb(42, 161, 152);">"RETRANSMITTED_PACKET"</span>: <span class="hljs-string" style="color: rgb(42, 161, 152);">"orange"</span>,
            <span class="hljs-string" style="color: rgb(42, 161, 152);">"QUEUED_PACKET"</span>: <span class="hljs-string" style="color: rgb(42, 161, 152);">"green"</span>,
            <span class="hljs-string" style="color: rgb(42, 161, 152);">"REJECTED_PACKET"</span>: <span class="hljs-string" style="color: rgb(42, 161, 152);">"red"</span>,
            <span class="hljs-string" style="color: rgb(42, 161, 152);">"SORTED_PACKET"</span>: <span class="hljs-string" style="color: rgb(42, 161, 152);">"pink"</span>,
            <span class="hljs-string" style="color: rgb(42, 161, 152);">"SCHEDULER_EMPTY_STATE"</span> : <span class="hljs-string" style="color: rgb(42, 161, 152);">"yellow"</span>,
            <span class="hljs-string" style="color: rgb(42, 161, 152);">"SCHEDULER_ALLOCATED_STATE"</span> : <span class="hljs-string" style="color: rgb(42, 161, 152);">"cyan"</span>,
            <span class="hljs-string" style="color: rgb(42, 161, 152);">"SCHEDULED_PACKETS"</span> : <span class="hljs-string" style="color: rgb(42, 161, 152);">"orange"</span>
        }
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> str(now()), sessionId, colorMap[request], request, response
    Log = read_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"NetLog"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"log"</span>)
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> Log:
        Log.append(format())
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
        Log = [format()]
    write_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"NetLog"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"log"</span>, Log)
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> <span class="hljs-keyword" style="color: rgb(133, 153, 0);">None</span>

<span class="hljs-comment" style="color: rgb(147, 161, 161);">#-------------- Component Data Models --------------</span>

AirInterface = NetworkDataManager(<span class="hljs-string" style="color: rgb(42, 161, 152);">"AirInterface"</span>) <span class="hljs-comment" style="color: rgb(147, 161, 161);"># Handles initial packets entering the network</span>
PhysicalUplinkControlChannel = NetworkDataManager(<span class="hljs-string" style="color: rgb(42, 161, 152);">"PhysicalUplinkControlChannel"</span>) <span class="hljs-comment" style="color: rgb(147, 161, 161);"># Modulates IP packets to MAC packets</span>
MAC = NetworkDataManager(<span class="hljs-string" style="color: rgb(42, 161, 152);">"MAC"</span>) <span class="hljs-comment" style="color: rgb(147, 161, 161);"># validates packets and handles retransmissions or queueing of verified packets</span>
Scheduler = NetworkDataManager(<span class="hljs-string" style="color: rgb(42, 161, 152);">"Scheduler"</span>) <span class="hljs-comment" style="color: rgb(147, 161, 161);"># sorts verified packets and schedules transmission of packets</span>
Transmission = {
        <span class="hljs-string" style="color: rgb(42, 161, 152);">"RR"</span> : { <span class="hljs-string" style="color: rgb(42, 161, 152);">"locked"</span> : <span class="hljs-keyword" style="color: rgb(133, 153, 0);">None</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"packets"</span> : [], <span class="hljs-string" style="color: rgb(42, 161, 152);">"data"</span> : [], <span class="hljs-string" style="color: rgb(42, 161, 152);">"size"</span> : <span class="hljs-number" style="color: rgb(42, 161, 152);">0</span> },
        <span class="hljs-string" style="color: rgb(42, 161, 152);">"PF"</span> : { <span class="hljs-string" style="color: rgb(42, 161, 152);">"locked"</span> : <span class="hljs-keyword" style="color: rgb(133, 153, 0);">None</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"packets"</span> : [], <span class="hljs-string" style="color: rgb(42, 161, 152);">"data"</span> : [], <span class="hljs-string" style="color: rgb(42, 161, 152);">"size"</span> : <span class="hljs-number" style="color: rgb(42, 161, 152);">0</span> },
        <span class="hljs-string" style="color: rgb(42, 161, 152);">"NV"</span> : { <span class="hljs-string" style="color: rgb(42, 161, 152);">"locked"</span> : <span class="hljs-keyword" style="color: rgb(133, 153, 0);">None</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"packets"</span> : [], <span class="hljs-string" style="color: rgb(42, 161, 152);">"data"</span> : [], <span class="hljs-string" style="color: rgb(42, 161, 152);">"size"</span> : <span class="hljs-number" style="color: rgb(42, 161, 152);">0</span> }
}
register_new_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"AirInterface"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"UERegister"</span>, [])
register_new_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"PhysicalUplinkControlChannel"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"QueuedMACPackets"</span>, [])
register_new_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"MAC"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"TransmissionQueue"</span>, [])
register_new_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"MAC"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"RejectedPackets"</span>, [])
register_new_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"Scheduler"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"SortedPackets"</span>, {})

<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">transmit</span><span class="hljs-params">(locked, scheduler, packet)</span>:</span>
    <span class="hljs-comment" style="color: rgb(147, 161, 161);"># transmits and terminates scheduled packets</span>
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">global</span> Transmission
    scheduler_delay = ms_elapsed(packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][-<span class="hljs-number" style="color: rgb(42, 161, 152);">1</span>]);
    matching_index = <span class="hljs-keyword" style="color: rgb(133, 153, 0);">None</span>
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> (len(Transmission[scheduler][<span class="hljs-string" style="color: rgb(42, 161, 152);">"data"</span>]) == <span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>):
        Transmission[scheduler][<span class="hljs-string" style="color: rgb(42, 161, 152);">"data"</span>].append({
            <span class="hljs-string" style="color: rgb(42, 161, 152);">"sessionId"</span> : locked,
            <span class="hljs-string" style="color: rgb(42, 161, 152);">"QoS"</span> : {
                 <span class="hljs-string" style="color: rgb(42, 161, 152);">"packets_received"</span> : <span class="hljs-number" style="color: rgb(42, 161, 152);">1</span>,
                 <span class="hljs-string" style="color: rgb(42, 161, 152);">"total_packet_delay"</span> : packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>],
                 <span class="hljs-string" style="color: rgb(42, 161, 152);">"total_retransmissions"</span> : packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">4</span>],
                 <span class="hljs-string" style="color: rgb(42, 161, 152);">"total_scheduler_delay"</span> : scheduler_delay,
                 <span class="hljs-string" style="color: rgb(42, 161, 152);">"total_packet_size"</span> : packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">8</span>]
            }
        })
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
        matching = [Transmission[scheduler][<span class="hljs-string" style="color: rgb(42, 161, 152);">"data"</span>].index(data) <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> data <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> Transmission[scheduler][<span class="hljs-string" style="color: rgb(42, 161, 152);">"data"</span>] <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> data[<span class="hljs-string" style="color: rgb(42, 161, 152);">"sessionId"</span>] == locked]
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> matching:
            matching_index = matching[<span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>];
            Transmission[scheduler][<span class="hljs-string" style="color: rgb(42, 161, 152);">"data"</span>][matching_index][<span class="hljs-string" style="color: rgb(42, 161, 152);">"QoS"</span>][<span class="hljs-string" style="color: rgb(42, 161, 152);">"packets_received"</span>]+=<span class="hljs-number" style="color: rgb(42, 161, 152);">1</span>
            Transmission[scheduler][<span class="hljs-string" style="color: rgb(42, 161, 152);">"data"</span>][matching_index][<span class="hljs-string" style="color: rgb(42, 161, 152);">"QoS"</span>][<span class="hljs-string" style="color: rgb(42, 161, 152);">"total_packet_delay"</span>]+=packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>]
            Transmission[scheduler][<span class="hljs-string" style="color: rgb(42, 161, 152);">"data"</span>][matching_index][<span class="hljs-string" style="color: rgb(42, 161, 152);">"QoS"</span>][<span class="hljs-string" style="color: rgb(42, 161, 152);">"total_retransmissions"</span>]+=packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">4</span>]
            Transmission[scheduler][<span class="hljs-string" style="color: rgb(42, 161, 152);">"data"</span>][matching_index][<span class="hljs-string" style="color: rgb(42, 161, 152);">"QoS"</span>][<span class="hljs-string" style="color: rgb(42, 161, 152);">"total_scheduler_delay"</span>]+=scheduler_delay
            Transmission[scheduler][<span class="hljs-string" style="color: rgb(42, 161, 152);">"data"</span>][matching_index][<span class="hljs-string" style="color: rgb(42, 161, 152);">"QoS"</span>][<span class="hljs-string" style="color: rgb(42, 161, 152);">"total_packet_size"</span>] += packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">8</span>]
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
            Transmission[scheduler][<span class="hljs-string" style="color: rgb(42, 161, 152);">"data"</span>].append({
                <span class="hljs-string" style="color: rgb(42, 161, 152);">"sessionId"</span> : locked,
                <span class="hljs-string" style="color: rgb(42, 161, 152);">"QoS"</span> : {
                     <span class="hljs-string" style="color: rgb(42, 161, 152);">"packets_received"</span> : <span class="hljs-number" style="color: rgb(42, 161, 152);">1</span>,
                     <span class="hljs-string" style="color: rgb(42, 161, 152);">"total_packet_delay"</span> : packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>],
                     <span class="hljs-string" style="color: rgb(42, 161, 152);">"total_retransmissions"</span> : packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">4</span>],
                     <span class="hljs-string" style="color: rgb(42, 161, 152);">"total_scheduler_delay"</span> : scheduler_delay,
                     <span class="hljs-string" style="color: rgb(42, 161, 152);">"total_packet_size"</span> : packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">8</span>]
                }
            })
    Transmission[scheduler][<span class="hljs-string" style="color: rgb(42, 161, 152);">"size"</span>] += packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">8</span>]
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> <span class="hljs-number" style="color: rgb(42, 161, 152);">200</span>

NetLog = NetworkDataManager(<span class="hljs-string" style="color: rgb(42, 161, 152);">"NetLog"</span>) <span class="hljs-comment" style="color: rgb(147, 161, 161);"># records events in the network</span>

<span class="hljs-comment" style="color: rgb(147, 161, 161);">#-------------- Network Endpoints --------------</span>

<span class="hljs-comment" style="color: rgb(147, 161, 161);"># inspect data structures</span>
<span class="hljs-decorator" style="color: rgb(38, 139, 210);">@app.route("/SubNetworkLTE/Internal/Inspect/&lt;path:section&gt;")</span>
<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">InspectData</span><span class="hljs-params">(section)</span>:</span>
    payload = {
        <span class="hljs-string" style="color: rgb(42, 161, 152);">"UERegister"</span> : read_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"AirInterface"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"UERegister"</span>),
        <span class="hljs-string" style="color: rgb(42, 161, 152);">"QueuedMACPackets"</span> : read_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"PhysicalUplinkControlChannel"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"QueuedMACPackets"</span>),
        <span class="hljs-string" style="color: rgb(42, 161, 152);">"TransmissionQueue"</span> : read_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"MAC"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"TransmissionQueue"</span>),
        <span class="hljs-string" style="color: rgb(42, 161, 152);">"RejectedPackets"</span> : read_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"MAC"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"RejectedPackets"</span>),
        <span class="hljs-string" style="color: rgb(42, 161, 152);">"SortedPackets"</span> : read_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"Scheduler"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"SortedPackets"</span>),
        <span class="hljs-string" style="color: rgb(42, 161, 152);">"Transmission"</span> : Transmission
    }
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> section == <span class="hljs-string" style="color: rgb(42, 161, 152);">"all"</span>:
        selection = payload
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
        selection = payload[section]
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> responsify(<span class="hljs-number" style="color: rgb(42, 161, 152);">200</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"%s data attached"</span> % section, selection)

<span class="hljs-comment" style="color: rgb(147, 161, 161);"># Reset</span>
<span class="hljs-decorator" style="color: rgb(38, 139, 210);">@app.route("/SubNetworkLTE/Reset")</span>
<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">Reset</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> str(reset_network())

<span class="hljs-comment" style="color: rgb(147, 161, 161);"># schedule packets</span>
<span class="hljs-decorator" style="color: rgb(38, 139, 210);">@app.route("/SubNetworkLTE/Scheduler/Schedule")</span>
<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">SchedulePackets</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">global</span> Transmission, scheduler_events
    <span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">Schedule</span><span class="hljs-params">(scheduler)</span>:</span>
        locked = Transmission[scheduler][<span class="hljs-string" style="color: rgb(42, 161, 152);">"locked"</span>]
        packets = Transmission[scheduler][<span class="hljs-string" style="color: rgb(42, 161, 152);">"packets"</span>]
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> scheduler == <span class="hljs-string" style="color: rgb(42, 161, 152);">"RR"</span>:
            <span class="hljs-comment" style="color: rgb(147, 161, 161);"># check size constraint</span>
            total_size = sum([packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][-<span class="hljs-number" style="color: rgb(42, 161, 152);">2</span>] <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> packet <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> packets]);
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> (total_size &lt;= transmission_bit_limit_per_tti):
                <span class="hljs-comment" style="color: rgb(147, 161, 161);"># send all packets on FIFO basis</span>
                group = packets[::-<span class="hljs-number" style="color: rgb(42, 161, 152);">1</span>]; group_size = total_size
                process = [transmit(locked, scheduler, packet) <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> packet <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> group];
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
                <span class="hljs-comment" style="color: rgb(147, 161, 161);"># audit and send on FIFO basis</span>
                <span class="hljs-keyword" style="color: rgb(133, 153, 0);">while</span> len(packets) &gt; <span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>:
                    group = []; group_size = <span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>; proceed = <span class="hljs-keyword" style="color: rgb(133, 153, 0);">True</span>
                    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">while</span> (group_size &lt;= transmission_bit_limit_per_tti <span class="hljs-keyword" style="color: rgb(133, 153, 0);">and</span> proceed):
                        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> len(packets) &gt; <span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>:
                            packet = packets.pop()
                            group_size += packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][-<span class="hljs-number" style="color: rgb(42, 161, 152);">2</span>]
                            group.append(packet)
                        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
                            proceed = <span class="hljs-keyword" style="color: rgb(133, 153, 0);">False</span>
                    <span class="hljs-comment" style="color: rgb(147, 161, 161);"># send group</span>
                    process = [transmit(locked, scheduler, packet) <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> packet <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> group];
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> scheduler == <span class="hljs-string" style="color: rgb(42, 161, 152);">"PF"</span>:
            <span class="hljs-comment" style="color: rgb(147, 161, 161);"># packet CQI Prioritization</span>
            packets = CQI_Prioritization(packets);
            <span class="hljs-comment" style="color: rgb(147, 161, 161);"># check size constraint</span>
            total_size = sum([packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][-<span class="hljs-number" style="color: rgb(42, 161, 152);">2</span>] <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> packet <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> packets]);
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> (total_size &lt;= transmission_bit_limit_per_tti):
                <span class="hljs-comment" style="color: rgb(147, 161, 161);"># send all packets after CQI prioritization</span>
                group = packets; group_size = total_size
                process = [transmit(locked, scheduler, packet) <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> packet <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> group];
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
                <span class="hljs-comment" style="color: rgb(147, 161, 161);"># audit and send on CQI basis</span>
                <span class="hljs-keyword" style="color: rgb(133, 153, 0);">while</span> len(packets) &gt; <span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>:
                    group = []; group_size = <span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>; proceed = <span class="hljs-keyword" style="color: rgb(133, 153, 0);">True</span>
                    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">while</span> (group_size &lt;= transmission_bit_limit_per_tti <span class="hljs-keyword" style="color: rgb(133, 153, 0);">and</span> proceed):
                        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> len(packets) &gt; <span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>:
                            packet = packets.pop(<span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>)
                            group_size += packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][-<span class="hljs-number" style="color: rgb(42, 161, 152);">2</span>]
                            group.append(packet)
                        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
                            proceed = <span class="hljs-keyword" style="color: rgb(133, 153, 0);">False</span>
                    <span class="hljs-comment" style="color: rgb(147, 161, 161);"># send group</span>
                    process = [transmit(locked, scheduler, packet) <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> packet <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> group];
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> scheduler == <span class="hljs-string" style="color: rgb(42, 161, 152);">"NV"</span>:
            <span class="hljs-comment" style="color: rgb(147, 161, 161);"># packet CQI Prioritization (size only)</span>
            packets = CQI_Prioritization(packets, <span class="hljs-keyword" style="color: rgb(133, 153, 0);">False</span>)
            <span class="hljs-comment" style="color: rgb(147, 161, 161);"># check size constraint</span>
            total_size = sum([packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][-<span class="hljs-number" style="color: rgb(42, 161, 152);">2</span>] <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> packet <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> packets])
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> (total_size &lt;= transmission_bit_limit_per_tti):
                <span class="hljs-comment" style="color: rgb(147, 161, 161);"># send all packets after CQI prioritization</span>
                group = packets
                group_size = total_size
                process = [transmit(locked, scheduler, packet) <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> packet <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> group]
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
                <span class="hljs-comment" style="color: rgb(147, 161, 161);"># audit and send on CQI basis</span>
                <span class="hljs-keyword" style="color: rgb(133, 153, 0);">while</span> len(packets) &gt; <span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>:
                    group = []
                    group_size = <span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>
                    proceed = <span class="hljs-keyword" style="color: rgb(133, 153, 0);">True</span>
                    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">while</span> (group_size &lt;= transmission_bit_limit_per_tti <span class="hljs-keyword" style="color: rgb(133, 153, 0);">and</span> proceed):
                        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> len(packets) &gt; <span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>:
                            packet = packets.pop(<span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>)
                            group_size += packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][-<span class="hljs-number" style="color: rgb(42, 161, 152);">2</span>]
                            group.append(packet)
                        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
                            proceed = <span class="hljs-keyword" style="color: rgb(133, 153, 0);">False</span>
                    <span class="hljs-comment" style="color: rgb(147, 161, 161);"># send group</span>
                    process = [transmit(locked, scheduler, packet) <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> packet <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> group]
        log(locked, <span class="hljs-string" style="color: rgb(42, 161, 152);">"SCHEDULED_PACKETS"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"%s packets with total size: %s bits were scheduled by: %s"</span> % (len(group), group_size, scheduler))
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> <span class="hljs-string" style="color: rgb(42, 161, 152);">"%s: %s"</span> % (<span class="hljs-number" style="color: rgb(42, 161, 152);">200</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"Packets were scheduled (%s bits)"</span> % group_size)
    <span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">isolate_free_MAC_packets</span><span class="hljs-params">(isolated=None)</span>:</span>
        SortedPackets = read_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"Scheduler"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"SortedPackets"</span>);
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> <span class="hljs-keyword" style="color: rgb(133, 153, 0);">not</span> isolated:
            packets = [];
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> sessionId <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> SortedPackets:
                <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> <span class="hljs-keyword" style="color: rgb(133, 153, 0);">not</span> SortedPackets[sessionId][<span class="hljs-string" style="color: rgb(42, 161, 152);">"busy"</span>]:
                    isolated = sessionId
                    SortedPackets[sessionId][<span class="hljs-string" style="color: rgb(42, 161, 152);">"busy"</span>] = <span class="hljs-keyword" style="color: rgb(133, 153, 0);">True</span>;  <span class="hljs-comment" style="color: rgb(147, 161, 161);"># lock this queue</span>
                    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">break</span>;
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">try</span>:
            <span class="hljs-comment" style="color: rgb(147, 161, 161);"># detach packets</span>
            packets = SortedPackets[isolated][<span class="hljs-string" style="color: rgb(42, 161, 152);">"packets"</span>]
            SortedPackets[isolated][<span class="hljs-string" style="color: rgb(42, 161, 152);">"packets"</span>] = []
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">except</span>:
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">pass</span>
        <span class="hljs-comment" style="color: rgb(147, 161, 161);"># update SortedPackets</span>
        write_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"Scheduler"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"SortedPackets"</span>, SortedPackets);
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> isolated, packets
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">try</span>:
        scheduler_events+=<span class="hljs-number" style="color: rgb(42, 161, 152);">1</span>
        schedulers = [<span class="hljs-string" style="color: rgb(42, 161, 152);">"RR"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"PF"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"NV"</span>]
        scheduler = schedulers[scheduler_events % len(schedulers)]
        <span class="hljs-comment" style="color: rgb(147, 161, 161);"># allocation</span>
        locked, packets = isolate_free_MAC_packets()
        <span class="hljs-comment" style="color: rgb(147, 161, 161);"># register on Transmission</span>
        Transmission[scheduler][<span class="hljs-string" style="color: rgb(42, 161, 152);">"locked"</span>] = locked
        Transmission[scheduler][<span class="hljs-string" style="color: rgb(42, 161, 152);">"packets"</span>] = packets
        log(locked, <span class="hljs-string" style="color: rgb(42, 161, 152);">"SCHEDULER_ALLOCATED_STATE"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"Scheduler: %s has been allocated %s packets"</span> % (scheduler, len(packets)))
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> Schedule(scheduler)
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">except</span> Exception <span class="hljs-keyword" style="color: rgb(133, 153, 0);">as</span> e:
        print(<span class="hljs-string" style="color: rgb(42, 161, 152);">"Error @ scheduler : %s"</span> % str(e))
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> <span class="hljs-string" style="color: rgb(42, 161, 152);">"%s: %s"</span> % (<span class="hljs-number" style="color: rgb(42, 161, 152);">400</span>, str(e))

<span class="hljs-comment" style="color: rgb(147, 161, 161);"># simulation agent firing mechanism for returning activity logs</span>
<span class="hljs-decorator" style="color: rgb(38, 139, 210);">@app.route("/SubNetworkLTE/NetLog")</span>
<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">ShowActivity</span><span class="hljs-params">()</span>:</span>
    Log = read_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"NetLog"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"log"</span>)
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> Log:
        html = <span class="hljs-string" style="color: rgb(42, 161, 152);">'&lt;html&gt;&lt;meta http-equiv="refresh" content="5"&gt;&lt;body bgcolor="black"&gt;&lt;div style="color: white; font-family: consolas; font-size:12;"&gt;%s&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;'</span>
        spool = <span class="hljs-string" style="color: rgb(42, 161, 152);">""</span>; count = -<span class="hljs-number" style="color: rgb(42, 161, 152);">1</span>
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> log <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> Log[::-<span class="hljs-number" style="color: rgb(42, 161, 152);">1</span>]:
            count+=<span class="hljs-number" style="color: rgb(42, 161, 152);">1</span>
            spool += <span class="hljs-string" style="color: rgb(42, 161, 152);">'&lt;p&gt;&lt;b&gt;%s --&gt; &lt;/b&gt;[%s] &lt;span style="color: %s;"&gt;[%s]&lt;/span&gt; [%s]'</span> % log + <span class="hljs-string" style="color: rgb(42, 161, 152);">' (#%s)&lt;/p&gt;'</span> % str(len(Log) - count)
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> html % spool
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> <span class="hljs-string" style="color: rgb(42, 161, 152);">"%s: %s"</span> % (<span class="hljs-number" style="color: rgb(42, 161, 152);">404</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"No activity logs found"</span>)

<span class="hljs-comment" style="color: rgb(147, 161, 161);"># simulation agent firing mechanism for sorting verified packets</span>
<span class="hljs-decorator" style="color: rgb(38, 139, 210);">@app.route("/SubNetworkLTE/Scheduler/Sorter")</span>
<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">SortPackets</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">try</span>:
        TransmissionQueue = read_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"MAC"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"TransmissionQueue"</span>)
        packet = TransmissionQueue.pop()  <span class="hljs-comment" style="color: rgb(147, 161, 161);"># release a MAC packet</span>
        <span class="hljs-comment" style="color: rgb(147, 161, 161);"># add scheduler start</span>
        packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>].append(now())
        write_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"MAC"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"TransmissionQueue"</span>, TransmissionQueue)
        sessionId = packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"sessionId"</span>]
        SortedPackets = read_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"Scheduler"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"SortedPackets"</span>)
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> SortedPackets:
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> sessionId <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> SortedPackets:
                SortedPackets[sessionId][<span class="hljs-string" style="color: rgb(42, 161, 152);">"packets"</span>].insert(<span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>, packet)
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
                SortedPackets[sessionId] = { <span class="hljs-string" style="color: rgb(42, 161, 152);">"busy"</span> : <span class="hljs-keyword" style="color: rgb(133, 153, 0);">False</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"packets"</span> : [packet] }
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
            SortedPackets = {sessionId: { <span class="hljs-string" style="color: rgb(42, 161, 152);">"busy"</span> : <span class="hljs-keyword" style="color: rgb(133, 153, 0);">False</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"packets"</span> : [packet] }}
        write_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"Scheduler"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"SortedPackets"</span>, SortedPackets)
        log(sessionId, <span class="hljs-string" style="color: rgb(42, 161, 152);">"SORTED_PACKET"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"1 packet with id: %s was sorted (%s bits)"</span> % (packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">5</span>], packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">8</span>]))
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> <span class="hljs-string" style="color: rgb(42, 161, 152);">"%s: %s"</span> % (<span class="hljs-number" style="color: rgb(42, 161, 152);">201</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"Packet was sorted (%s bits)"</span> % packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">8</span>])
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">except</span> Exception <span class="hljs-keyword" style="color: rgb(133, 153, 0);">as</span> e:
        print(<span class="hljs-string" style="color: rgb(42, 161, 152);">"Error @ sorter : %s"</span> % str(e))
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> <span class="hljs-string" style="color: rgb(42, 161, 152);">"%s: %s"</span> % (<span class="hljs-number" style="color: rgb(42, 161, 152);">404</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"No packet found"</span>)

<span class="hljs-comment" style="color: rgb(147, 161, 161);"># simulation agent firing mechanism for validating packet integrity</span>
<span class="hljs-decorator" style="color: rgb(38, 139, 210);">@app.route("/SubNetworkLTE/MAC/Profiler")</span>
<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">ProfilePackets</span><span class="hljs-params">()</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">retransmit</span><span class="hljs-params">(packet)</span>:</span>
        <span class="hljs-comment" style="color: rgb(147, 161, 161);"># check if retransmission_limit reached</span>
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">4</span>] + <span class="hljs-number" style="color: rgb(42, 161, 152);">1</span> &gt; retransmission_limit:
            <span class="hljs-comment" style="color: rgb(147, 161, 161);"># reject this MAC packet</span>
            RejectedPackets = read_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"MAC"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"RejectedPackets"</span>)
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> RejectedPackets:
                RejectedPackets.append(packet)
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
                RejectedPackets = [packet]
            write_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"MAC"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"RejectedPackets"</span>, RejectedPackets)
            log(packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"sessionId"</span>], <span class="hljs-string" style="color: rgb(42, 161, 152);">"REJECTED_PACKET"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"1 packet with id: %s was rejected (%s bits)"</span> % (packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">5</span>], packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">8</span>]))
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> <span class="hljs-string" style="color: rgb(42, 161, 152);">"%s: %s"</span> % (<span class="hljs-number" style="color: rgb(42, 161, 152);">204</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"Packet was rejected (%s bits)"</span> % packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">8</span>])
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
            packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">4</span>]+=<span class="hljs-number" style="color: rgb(42, 161, 152);">1</span>
            retransmitted_session = MAC2IPSession(packet) <span class="hljs-comment" style="color: rgb(147, 161, 161);"># convert MAC packet back to IP session</span>
            UERegister = read_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"AirInterface"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"UERegister"</span>)
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> UERegister:
                UERegister.append(retransmitted_session)  <span class="hljs-comment" style="color: rgb(147, 161, 161);"># lower priority for unvalidated retransmitted packets</span>
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
                UERegister = [retransmitted_session]
            write_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"AirInterface"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"UERegister"</span>, UERegister) <span class="hljs-comment" style="color: rgb(147, 161, 161);"># retransmit IP session</span>
            log(packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"sessionId"</span>], <span class="hljs-string" style="color: rgb(42, 161, 152);">"RETRANSMITTED_PACKET"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"1 packet with id: %s was retransmitted (%s bits)"</span> % (packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">5</span>], packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">8</span>]))
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> <span class="hljs-string" style="color: rgb(42, 161, 152);">"%s: %s"</span> % (<span class="hljs-number" style="color: rgb(42, 161, 152);">200</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"Packet was retransmitted (%s bits)"</span> % packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">8</span>])
    <span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">queue</span><span class="hljs-params">(packet)</span>:</span>
        TransmissionQueue = read_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"MAC"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"TransmissionQueue"</span>)
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> TransmissionQueue:
            TransmissionQueue.insert(<span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>, packet)  <span class="hljs-comment" style="color: rgb(147, 161, 161);"># FIFO</span>
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
            TransmissionQueue = [packet]
        write_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"MAC"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"TransmissionQueue"</span>, TransmissionQueue) <span class="hljs-comment" style="color: rgb(147, 161, 161);"># queue this transmittable MAC packet</span>
        log(packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"sessionId"</span>], <span class="hljs-string" style="color: rgb(42, 161, 152);">"QUEUED_PACKET"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"1 packet with id: %s was queued (%s bits)"</span> % (packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">5</span>], packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">8</span>]))
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> <span class="hljs-string" style="color: rgb(42, 161, 152);">"%s: %s"</span> % (<span class="hljs-number" style="color: rgb(42, 161, 152);">201</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"Packet was queued (%s bits)"</span> % packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">8</span>])
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">try</span>:
        QueuedMACPackets = read_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"PhysicalUplinkControlChannel"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"QueuedMACPackets"</span>)
        packet = QueuedMACPackets.pop() <span class="hljs-comment" style="color: rgb(147, 161, 161);"># release a MAC packet</span>
        write_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"PhysicalUplinkControlChannel"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"QueuedMACPackets"</span>, QueuedMACPackets)
        <span class="hljs-comment" style="color: rgb(147, 161, 161);"># test MAC packet for errors, handle contextually</span>
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"payload_bits"</span>] == packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">3</span>]:
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> queue(packet)
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> retransmit(packet)
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">except</span> Exception <span class="hljs-keyword" style="color: rgb(133, 153, 0);">as</span> e:
        print(<span class="hljs-string" style="color: rgb(42, 161, 152);">"Error @ profiler : %s"</span> % str(e))
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> <span class="hljs-string" style="color: rgb(42, 161, 152);">"%s: %s"</span> % (<span class="hljs-number" style="color: rgb(42, 161, 152);">404</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"No packet found"</span>)

<span class="hljs-comment" style="color: rgb(147, 161, 161);"># simulation agent firing mechanism for transcoding IP packets to MAC packets</span>
<span class="hljs-decorator" style="color: rgb(38, 139, 210);">@app.route("/SubNetworkLTE/PhysicalUplinkControlChannel/Modulation")</span>
<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">ModulatePackets</span><span class="hljs-params">()</span>:</span>
    session = <span class="hljs-keyword" style="color: rgb(133, 153, 0);">None</span>
    UERegister = read_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"AirInterface"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"UERegister"</span>)
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> UERegister:
        session = UERegister.pop()
        write_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"AirInterface"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"UERegister"</span>, UERegister)
        ip_address, session_time, sessionId, n_packets, ip_packets_loggable = session
        ip_packets = [log <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> log <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> ip_packets_loggable]
        <span class="hljs-comment" style="color: rgb(147, 161, 161);"># Packet Modulation</span>
        delay = ms_elapsed(session_time); modulated = <span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> packet <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> ip_packets:
            delay+=packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">3</span>]  <span class="hljs-comment" style="color: rgb(147, 161, 161);"># add retransmission delay</span>
            mod_started = now()
            MAC_packets = []
            packetId = Id()
            field = transcode_bits(packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"payload_bits"</span>], transcoding_plan(packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>], MAC_packet_size))
            packet_index = -<span class="hljs-number" style="color: rgb(42, 161, 152);">1</span>
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> band <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> field:
                packet_index+=<span class="hljs-number" style="color: rgb(42, 161, 152);">1</span>
                source_bits, trans_bits = band
                mod_delay = ms_elapsed(mod_started); delay+=mod_delay <span class="hljs-comment" style="color: rgb(147, 161, 161);"># add modulation delay</span>
                <span class="hljs-comment" style="color: rgb(147, 161, 161);"># FIFO Queue, preserve retransmissions</span>
                MAC_packets.insert(<span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>, MAC_Packet(sessionId, trans_bits, ip_address, delay, source_bits, packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">4</span>], packetId, packet_index, len(field), len(trans_bits)))
            modulated+=len(MAC_packets)
            QueuedMACPackets = read_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"PhysicalUplinkControlChannel"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"QueuedMACPackets"</span>)
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> QueuedMACPackets:
                QueuedMACPackets = MAC_packets + QueuedMACPackets <span class="hljs-comment" style="color: rgb(147, 161, 161);"># ensure FIFO</span>
            <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
                QueuedMACPackets = MAC_packets
            write_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"PhysicalUplinkControlChannel"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"QueuedMACPackets"</span>, QueuedMACPackets)
            log(sessionId, <span class="hljs-string" style="color: rgb(42, 161, 152);">"MAC_PACKETS_MODULATED"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"%s MAC packets from session %s delayed %sms"</span> % (len(MAC_packets), sessionId, mod_delay))
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> <span class="hljs-string" style="color: rgb(42, 161, 152);">"%s: %s"</span> % (<span class="hljs-number" style="color: rgb(42, 161, 152);">200</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"Successfully modulated %s packets"</span> % modulated)
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> <span class="hljs-string" style="color: rgb(42, 161, 152);">"%s: %s"</span> % (<span class="hljs-number" style="color: rgb(42, 161, 152);">404</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"No session found"</span>)

<span class="hljs-comment" style="color: rgb(147, 161, 161);"># simulation agent firing mechanism for authenticating UE sessions and receiving IP packets</span>
<span class="hljs-decorator" style="color: rgb(38, 139, 210);">@app.route("/SubNetworkLTE/AirInterface/UERegistration/&lt;path:n_packets&gt;")</span>
<span class="hljs-function"><span class="hljs-keyword" style="color: rgb(133, 153, 0);">def</span> <span class="hljs-title" style="color: rgb(38, 139, 210);">UERegistration</span><span class="hljs-params">(n_packets)</span>:</span>
    ip_address = request.remote_addr
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">try</span>:
        session = UESession(ip_address, int(n_packets))
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">except</span> Exception <span class="hljs-keyword" style="color: rgb(133, 153, 0);">as</span> e:
        print(<span class="hljs-string" style="color: rgb(42, 161, 152);">"Error @ create_session : %s"</span> % str(e))
        <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> <span class="hljs-string" style="color: rgb(42, 161, 152);">"%s: %s"</span> % (<span class="hljs-number" style="color: rgb(42, 161, 152);">400</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"Error creating session: packet_size not specified"</span>)
    UERegister = read_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"AirInterface"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"UERegister"</span>)
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> UERegister:
        UERegister.insert(<span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>, session)  <span class="hljs-comment" style="color: rgb(147, 161, 161);">#FIFO Queue</span>
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">else</span>:
        UERegister = [session]
    write_netbuffer(<span class="hljs-string" style="color: rgb(42, 161, 152);">"AirInterface"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"UERegister"</span>, UERegister)
    log(session[<span class="hljs-number" style="color: rgb(42, 161, 152);">2</span>], <span class="hljs-string" style="color: rgb(42, 161, 152);">"IP_PACKETS_RECEIVED"</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">'UE at &lt;span style="color: cyan;"&gt;%s&lt;/span&gt; sent %s IP packets of %s bits'</span> % (ip_address, n_packets, sum([this_packet[<span class="hljs-string" style="color: rgb(42, 161, 152);">"header"</span>][<span class="hljs-number" style="color: rgb(42, 161, 152);">0</span>] <span class="hljs-keyword" style="color: rgb(133, 153, 0);">for</span> this_packet <span class="hljs-keyword" style="color: rgb(133, 153, 0);">in</span> session[<span class="hljs-number" style="color: rgb(42, 161, 152);">4</span>]])))
    <span class="hljs-keyword" style="color: rgb(133, 153, 0);">return</span> <span class="hljs-string" style="color: rgb(42, 161, 152);">"%s: %s"</span> % (<span class="hljs-number" style="color: rgb(42, 161, 152);">200</span>, <span class="hljs-string" style="color: rgb(42, 161, 152);">"Successfully registered %s packets"</span> % n_packets)

<span class="hljs-keyword" style="color: rgb(133, 153, 0);">if</span> __name__ == <span class="hljs-string" style="color: rgb(42, 161, 152);">"__main__"</span>:
    app.run(host=server_host, port=server_port, threaded=<span class="hljs-keyword" style="color: rgb(133, 153, 0);">True</span>)
</code></pre></div>
